Zepto(function(e){function t(t,r){document.activeElement.blur(),e(document).blur(),e.ajax({type:"POST",url:Y+"/UserLogin",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({login:t,pass:r}),dataType:"json",success:function(e){console.log(e.d),X=JSON.parse(e.d),0!=X?(tt.changes=0,tt.logged=!0,tt.logTime=k(),tt.user=X,b("Login successful","short","top"),setTimeout(function(){ht.settings()},10)):setTimeout(function(){pt.hide(),b("Incorrect Login details","short","top")},50)},error:function(e,t){setTimeout(function(){pt.hide(),b("Ajax error : "+t.toString(),"long","top")},50)}})}function r(){return 1==C.Browser?window.TEMPORARY:LocalFileSystem.PERSISTENT}function o(e){if(1==C.Browser){var t=N(e),r=new Blob([t],{type:"text/plain"});return r}var r=N(e);return r}function n(t){rt=!0;var r=new Image;e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").attr({src:" ",width:"0",height:"0"}).css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("viewport>pog").remove(),r.src=t,r.onload=function(){var t,o,n=r.width,a=r.height,s=e("map").height()/a,t=s*n,o=s*a;t>e("map").width()&&(s=e("map").width()/t,t=s*t,o=s*o);var l=e("map").width()/2-t/2,c=e("map").height()/2-o/2;e("map>viewport>img").attr({src:r.src,width:t,height:o,offset:l+" "+c}).css({"-webkit-transform":"matrix(1,0,0,1,"+l+","+c+")"}),i(),setTimeout(function(){e("#MapsMasterPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").attr("open",""),pt.hide()},10)}}function a(t,r){DeviceAdd=!0,Dt.empty(),bt.empty();var o=e("map").position();t-=parseFloat(o.left),r-=parseFloat(o.top);var n=e("map>viewport>img").css("-webkit-transform");n=n.substr(n.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");var a=n[5],s=n[4];t-=s,r-=a,t=parseFloat(t)/parseFloat(e("map>viewport>img").width())*j,r=parseFloat(r)/parseFloat(e("map>viewport>img").height())*B;for(var l,c=0;c<V.length;c++)if(V[c].ID_Device==e("#ulFloat").attr("value")){l=V[c].ID_Device,V[c].X=t,V[c].Y=r,V[c].ID_Map=ot.ID_Map,V[c].Image="devimg/default.png";var p=at.ID_Group+",";p+=ot.ID_Map+",",p+=parseInt(t)+","+parseInt(r)+",",p+=!1+"",M(V[c].ID_Device,p.toString())}e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open",""),setTimeout(function(){i(),nt=S(l),e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==nt.ID_Device&&e(r).addClass("selecteddevice")}),T()},10)}function i(){l(),e("viewport>pog").remove();var t="",r=e("map>viewport>img").css("-webkit-transform");r=r.substr(r.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");for(var o=r[5],n=r[4],a=0;a<V.length;a++)if(V[a].ID_Map==ot.ID_Map){var i=parseFloat(V[a].X)/j*parseFloat(e("map>viewport>img").width()),s=parseFloat(V[a].Y)/B*parseFloat(e("map>viewport>img").height()),c="";c=100>s?"1,0,0,-1":100>i?"0,-1,-1,0":i>j-100?"0,-1,1,0":"1,0,0,1";var p="-webkit-transform: matrix("+c+","+i+","+s+"); top:"+o+"; left:"+n+";",u=1==V[a].Locked?"locked":"unlocked";console.log(u),t+="<pog style='"+p+"' class='"+u+"'id='"+V[a].ID_Device+"'></pog>"}e("map>viewport").append(t)}function s(){if(1==rt){l(),e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"});var t,r,o=e("map>viewport>img").width(),n=e("map>viewport>img").height();console.log(o+" "+n);var a=e("map").height()/n;r=a*n,t=a*o,t>e("map").width()&&(a=e("map").width()/t,r=a*r,t=a*t),console.log(r+" "+t);var s=e("map").width()/2-t/2,c=e("map").height()/2-r/2;s=Math.round(s),c=Math.round(c),e("map>viewport>img").attr({width:t,height:r,offset:s+" "+c}).css({"-webkit-transform":"matrix(1,0,0,1,"+s+","+c+")"}),i()}}function l(){e("viewport>pog").remove()}function c(){rt=!1,e("map>viewport").css({"-webkit-transform":"matrix(1,0,0,1,0,0)"}),e("map>viewport>img").attr({src:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",width:"0",height:"0"}).css({"-webkit-transform":"matrix(1,0,0,1,0,0)"})}function p(t){var r=k(),o="";o+='<dropdown class="master expand"><actionbar><title>'+r+'</title><a href="#" class="button" id=""></a></actionbar><dropdown class="content">';for(var n=0;n<t.length;n++){null==t[n].ID&&(t[n].ID="Unknown Device"),o+='<dropdown class="master expand"><actionbar><title>'+t[n].ID+'</title><a href="#" class="button" id=""></a></actionbar><dropdown class="content">';for(var a=0;a<t[n].Tasks.length;a++)console.log(""),o+='<row class="item"><p>'+t[n].Tasks[a].Type+"</p><p>"+t[n].Tasks[a].Value+"</p></row>";o+="</dropdown></dropdown>"}o+="</dropdown></dropdown>",e("#logbookLog").prepend(o)}function u(e){for(var t=e.slice(0),r=new Array,o=new Array;t.length>0;)r.push(t[0]),r.length==q&&(o.push(r),r=new Array),t.splice(0,1);return 0!=r.length&&(o.push(r),r=new Array),o}function d(){if(e("#infoMapNum").val("Number of Maps : "+z.length),z.length>0){var t=z.slice(0);t=u(t);var r="";r+="<panel class='group'>";for(var o=0;o<t.length;o++){r+="<panel right class='child'><scroll class='y'><row class='content'>";for(var n=0;n<t[o].length;n++){var a=t[o][n].Name,i=t[o][n].Description,s=t[o][n].ID_Map;(0==a.length||null==a)&&(a="Name unavalible"),0==i.length&&(i="No description"),r+="<row class='button item map' id='"+s+"'><span><name>"+a+"</name><serial>"+i+"</serial></span></row>"}r+="</row></scroll></panel>"}r+="</panel>",t.length>1&&(r+='<actionbar><a href="#" class="button backward" id="btnBackwards"></a><indicator>0</indicator><a href="#" class="button forward" id="btnforwards"></a></actionbar>'),e("#MapsMasterGroup").empty().append(r),e("#MapsMasterGroup>panel.group").children().hide(),setTimeout(function(){e("#MapsMasterGroup>panel.group>panel:first-child").attr("open","").removeAttr("left").removeAttr("right").show()},1),r.length=0}else{var r="";r+="<row class='item none' id='none'><span><name>No Maps</name><serial>This group contains no maps</serial></span></row>",console.log("Drawing"),e("#MapsMasterGroup").empty().append(r),r.length=0}}function g(){var t="";t+="<row class='item none' id='none'><span><name>Loading Devices</name><serial>This may take some time.</serial></span></row>",console.log("Drawing"),e("#DevicesonMapGroup").empty().append(t),t.length=0}function h(){var t="";t+="<row class='item none' id='none'><span><name>Loading Devices..</name><serial>This may take some time.</serial></span></row>",e("#MissingDevicesGroups").empty().append(t),t.length=0}function m(){e("#infoDeviceNum").val("Number of Devices : "+V.length)}function v(){var t=tt.lastUpdate.replace(/\"/g," ");t.length>0?e("#infoDownloadDate").val(t):e("#infoDownloadDate").val("Unknown Date")}function f(){ot.Description?e("#MapTitle").empty().html(ot.Name):e("#MapTitle").empty().html("OneStop")}function w(){return R.online}function D(t,r){for(var o=0;o<V.length;o++)V[o].ID_Device==nt.ID_Device&&("locked"==r&&(V[o].Locked=t,e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==V[o].ID_Device&&e(r).toggleClass("unlocked").toggleClass("locked")}),I(nt.ID_Device,"lock",t),nt=V[o],et=!0),"description"==r&&(V[o].Description=t,I(nt.ID_Device,"description",t),e("#infoDeviceDescription").val(nt.Description),nt=V[o],T(),et=!0),"location"==r&&(V[o].Location=t,I(nt.ID_Device,"location",t),e("#infoDeviceLocation").val(nt.Location),nt=V[o],T(),et=!0),"serialnumber"==r&&(V[o].SerialNumber=t,I(nt.ID_Device,"serialnumber",t),e("#infoDeviceSerialNumber").val(nt.SerialNumber),nt=V[o],T(),et=!0),"assetnumber"==r&&(V[o].AssetNumber=t,I(nt.ID_Device,"assetnumber",t),e("#infoDeviceAssetNumber").val(nt.AssetNumber),nt=V[o],T(),et=!0))}function b(e,t,r){window.plugins.toast.show(e,t,r,function(e){console.log("Toast success "+e)},function(e){alert("Toast Error"+e)})}function y(t){try{c(),l(),s(),ot.length=0,nt=0,z.length=0,V.length=0,it.length=0,st.length=0,Dt.empty(),bt.empty(),Z.length=0,e("li.button.remove").removeClass("remove"),e("#deleteoptions").html(Z.length+" selected"),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),at=W[t],console.log(at),e("#inputselectGroup").val(at.ID_Group+" - "+at.Name),pt.show(),mt.data()}catch(r){alert("trying changeGroup with num "+t+" error: "+r.toString())}}function A(){e("#imageDevice").css("background-image","url(./img/icon.png)"),e("#infoDevicePosition").val(""),e("#infoDeviceDescription").val(""),e("#infoDeviceLocation").val(""),e("#infoDeviceSerialNumber").val(""),e("#infoDeviceAssetNumber").val(""),e("#infoDeviceLock").prop("checked",0)}function T(){ut.ClearImage(),e("#infoDevicePosition").val(nt.X.toFixed(0)+" : "+nt.Y.toFixed(0)),e("#infoDeviceDescription").val(nt.Description),""==nt.Location||null==nt.Location?e("#infoDeviceLocation").val("No Location"):e("#infoDeviceLocation").val(nt.Location),""==nt.SerialNumber||null==nt.SerialNumber?e("#infoDeviceSerialNumber").val("No Serial"):e("#infoDeviceSerialNumber").val(nt.SerialNumber),""==nt.AssetNumber||null==nt.AssetNumber?e("#infoDeviceAssetNumber").val("No Asset Number"):e("#infoDeviceAssetNumber").val(nt.AssetNumber),1==nt.Locked?e("#infoDeviceLock").prop("checked",1):e("#infoDeviceLock").prop("checked",0)}function I(e,t,r){var o={Type:"save",Attribute:t,Value:r};if(H.length>0){for(var n=!1,a=0;a<H.length;a++)H[a].ID==e&&(n=!0,H[a].Tasks.push(o));0==n&&(console.log(e+"Add to End"),H.push({ID:e,Tasks:[]}),H[H.length-1].Tasks.push(o))}else H.push({ID:e,Tasks:[]}),H[H.length-1].Tasks.push(o)}function M(e,t){var r={Type:"insert",Value:t};if(H.length>0){for(var o=!1,n=0;n<H.length;n++)H[n].ID==e&&(o=!0,H[n].Tasks.push(r));0==o&&(H.push({ID:e,Tasks:[]}),H[H.length-1].Tasks.push(r))}else H.push({ID:e,Tasks:[]}),H[H.length-1].Tasks.push(r)}function F(e){var t={Type:"remove",Attribute:null,Value:null};if(H.length>0){for(var r=!1,o=0;o<H.length;o++)H[o].ID==e&&(r=!0,H[o].Tasks.push(t));0==r&&(H.push({ID:e,Tasks:[]}),H[H.length-1].Tasks.push(t))}else H.push({ID:e,Tasks:[]}),H[H.length-1].Tasks.push(t)}function S(e){for(var t=0;t<V.length;t++)if(V[t].ID_Device==e)return V[t]}function k(){var e=new Date;return e.toUTCString()}function N(e){return JSON.stringify(e)}function N(e){return JSON.stringify(e)}function O(e,t,r,o){navigator.notification.confirm(e,t,r,o)}function _(e,t,r,o,n){navigator.notification.prompt(e,t,r,o,n)}function G(){e("#btnTogPanel").trigger("tap"),P=!0,1==C.Browser||navigator.splashscreen.hide()}function x(){console.log("getting first group"),e("#GroupPanel>panel.group").empty();for(var t=W[0].ID_Group,r=0;r<W.length;r++)W[r].ID_Group==t&&y(r);wt.MoveForward()}try{var P=!1,C={IOS:!!e.os.ios,Android:!!e.os.android,Version:e.os.version,Browser:!1},R={status:"offline",type:"none",online:!1};C.Browser=!1,e.each(e("scroll.y"),function(t,r){e(r).css({width:"100%","max-width":e(r).width(),"min-width":e(r).width()})});var E={start:{},end:{},center:{},dist:{},oldScale:1,scale:1,matrix:null};C.IOS&&(e("#deviceStyle").attr("href","css/ios.css"),parseFloat(C.Version)>=7),C.Android&&e("#deviceStyle").attr("href","css/ios.css"),C.Android||C.IOS||e("#deviceStyle").attr("href","css/ios.css");var L,U=!0,j=1e3,B=750,q=30,J="http://192.168.100.108:1234",Y=J+"/mobile.asmx";1==C.Browser?(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,L=0):L=0,String.prototype.capitalize=function(){return this.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})};var X=new Object,W=new Array,V=new Array,z=new Array,H=new Array,Z=new Array,K=!1,Q=!1,$=!1,et=!1,tt={logged:!1,logTime:"",user:new Object,lastUpdate:"",changes:0},rt=!1,ot=new Object,nt=new Object,at=new Object,it=new Array,st=new Array,lt={show:function(){e("shadow").removeAttr("novis")},hide:function(){e("shadow").attr("novis","")}},ct={show:function(){e("#login").removeAttr("novis")},hide:function(){e("#login").attr("novis","")}},pt={show:function(){C.Browser||window.plugins.spinnerDialog.show()},hide:function(){C.Browser||window.plugins.spinnerDialog.hide()}},ut={show:function(){e("#DeviceImageDisplay").removeAttr("novis")},hide:function(){e("#DeviceImageDisplay").attr("novis","")},loadImage:function(t){e("#DeviceImageDisplay>content").empty().append("<img/>");var r=e("#DeviceImageDisplay>content>img"),o=new Image;o.src=t,o.onload=function(){var e,t,n=o.width,a=o.height;if(a<r.parent().height()&&n<r.parent().width()){var i=Math.round(r.parent().width()/2-n/2),s=Math.round(r.parent().height()/2-a/2);console.log(i+" "+s),r.width(n),r.height(a),r.attr("src",o.src),r.css({"-webkit-transform":"matrix(1,0,0,1,1,"+s+")"})}else{var l=r.parent().height()/a,t=a*l,e=n*l;e>r.parent().width()&&(l=r.parent().width()/e,e=l*e,t=l*t);var i=Math.round(r.parent().width()/2-e/2),s=Math.round(r.parent().height()/2-t/2);console.log(i+" "+s),r.width(e),r.height(t),r.attr("src",o.src),r.css({"-webkit-transform":"matrix(1,0,0,1,1,"+s+")"})}}},ClearImage:function(){e("#DeviceImageDisplay>content").empty()},Resizemage:function(){if(null==e("#DeviceImageDisplay").attr("novis")){console.log("Resizing"),console.log(e("#DeviceImageDisplay").attr("novis"));var t,r,o=e("#DeviceImageDisplay>content>img"),n=o.width(),a=o.height();if(a<o.parent().height()&&n<o.parent().width()){Math.round(o.parent().width()/2-n/2);var i=Math.round(o.parent().height()/2-a/2);o.width(n),o.height(a),o.css({"-webkit-transform":"matrix(1,0,0,1,1,"+i+")"})}else{var s=o.parent().height()/a,r=a*s,t=n*s;t>o.parent().width()&&(s=o.parent().width()/t,t*=s,r*=s),Math.round(o.parent().width()/2-t/2);var i=Math.round(o.parent().height()/2-r/2);o.width(t),o.height(r),o.css({"-webkit-transform":"matrix(1,0,0,1,1,"+i+")"})}}}},dt={groups:function(){e.ajax({type:"POST",url:Y+"/GetAvalibleGroups",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:tt.user.ID_Group}),dataType:"json",success:function(e){W=JSON.parse(e.d),0!=W&&ht.groups()},error:function(){}})},maps:function(){e.ajax({type:"POST",url:Y+"/GetMaps",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:at.ID_Group}),dataType:"json",success:function(e){0==e.d?z.length=0:z=JSON.parse(e.d),dt.devices()},error:function(){}})},devices:function(){e.ajax({type:"POST",url:Y+"/GetDevices",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({data:at.ID_Group}),dataType:"json",success:function(e){0==e.d?V.length=0:V=JSON.parse(e.d),tt.lastUpdate=k(),ht.data(),b("Data downloaded","short","top")},error:function(){}})},changes:function(){H[H.length-1].Date&&H.splice(H.length-1,1),e.ajax({type:"POST",url:Y+"/Tasks",contentType:"application/json; charset=utf-8",async:!0,data:JSON.stringify({todo:H}),success:function(e){H.length=0,tt.changes=0;var t=JSON.parse(e.d);console.log(t),p(t),vt.changes(),Z.length=0,setTimeout(function(){ht.settings(),ht.data(),b("Upload finished - Check log","short","top"),setTimeout(function(){it.length=0,st.length=0;for(var e=0;e<V.length;e++)V[e].ID_Map==ot.ID_Map&&it.push(V[e]),0==V[e].ID_Map&&st.push(V[e]);it=u(it),st=u(st),Dt.empty(),bt.empty(),g(),h(),setTimeout(function(){Dt.MoveForward()},100)},100),i()},100)},error:function(t,r){alert(r),e("#logbookLog").append("<p>"+r+"</p>"),pt.hide(),b("Upload failed","short","top")}})}},gt={getPicture:function(){try{navigator.camera.getPicture(gt.pictureSuccess,gt.pictureFail,{quality:50,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.CAMERA,encodingType:navigator.camera.EncodingType.JPEG,saveToPhotoAlbum:!0})}catch(e){alert(e.toString())}},getCameraroll:function(){try{navigator.camera.getPicture(gt.pictureSuccess,gt.pictureFail,{quality:50,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY,encodingType:navigator.camera.EncodingType.JPEG})}catch(e){alert(e.toString())}},pictureSuccess:function(e){try{var t=e.substr(e.lastIndexOf("/")+1);setTimeout(function(){_("Give the image a name",function(r){if(1==r.buttonIndex){t=r.input1+".jpg";for(var o=0;o<V.length;o++)V[o].ID_Device==nt.ID_Device&&(V[o].Image="devimg/"+t,nt=V[o]);I(nt.ID_Device,"image","devimg/"+t),ht.data(),gt.copyImageToDir(e,t)}},"Device Image",["Done","Cancel"],nt.Description)},10)}catch(r){alert(N(r))}},pictureFail:function(){alert("Camera Fail: "+_t.toString())},copyImageToDir:function(e,t){var o="";setTimeout(function(){window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile/devimg",{create:!0},function(r){o=r.toURL(),window.resolveLocalFileSystemURI(e,function(r){window.resolveLocalFileSystemURI(o,function(o){r.copyTo(o,t,function(){if(1==w())try{var r=Y+"/SaveImage",o=new FileUploadOptions;o.fileKey="file",o.fileName=t,o.mimeType="image/jpeg";var n=new FileTransfer;n.upload(e,r,function(){b("Image uploaded","short","top"),T(),ut.hide(),setTimeout(function(){ut.show(),mt.devImg()},10)},function(e){alert("Upload Transfer error: "+N(e))},o)}catch(a){alert("Upload error: "+a.toString())}else b("Unable to uplaod device image","long","top")},function(e){switch(e.code){case 12:alert("Copy Failure: Device image with that name already exists");break;default:alert(e.code)}})},ft.error)},ft.error)},ft.error)},ft.error)},100)}},ht={settings:function(){var e="settings.json",t=tt;window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),0==W.length&&mt.groups()},r.write(o(t))},ft.error)},ft.error)},ft.error)},ft.error)},groups:function(){var e="groups.json",t=W;window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),x(),setTimeout(function(){ct.hide(),pt.hide()},50)},r.write(o(t))},ft.error)},ft.error)},ft.error)},ft.error)},data:function(){var e=at.ID_Group+".json",t=new Object;t.Date=k(),t.Maps=z,t.Devices=V,window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(e,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+e)},r.onwriteend=function(){console.log("Write complete: "+e),d(),m(),v(),pt.hide()},r.write(o(t))},ft.error)},ft.error)},ft.error)},ft.error)},changes:function(){var e,t="changes.json";H.splice(H.length,1),H.push({Date:k()}),e=H,window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(t,{create:!0},function(r){r.createWriter(function(r){r.onwritestart=function(){console.log("Writing File: "+t)},r.onwriteend=function(){H.length=0},r.write(o(e))},ft.error)},ft.error)},ft.error)},ft.error)}},mt={settings:function(){var t="settings.json";window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile",{create:!0},function(r){r.getFile(t,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(this.result.length>0){var t=JSON.parse(this.result);tt=t,1==tt.logged?(console.log(tt),e("#inputPrevUsername").val(tt.user.Name),e("#inputLogTime").val(tt.logTime)):console.log("Not logged in"),0==P&&G()}else e("#inputPrevUsername").val("No previous user"),e("#inputLogTime").val("  "),0==P&&G()},r.readAsText(t)},ft.error)},function(t){1==t.code?(console.log("Settings file not found."),e("#inputPrevUsername").val("No previous user"),e("#inputLogTime").val("  "),0==P&&G()):ft.error(t)})},ft.error)},ft.error)},groups:function(){var t="groups.json";window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile/data",{create:!0},function(r){r.getFile(t,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(console.log("Reading Groups File"),this.result.length>0){var t=JSON.parse(this.result);W.length=0;for(var r=0;r<t.length;r++)W.push(t[r]);x(),setTimeout(function(){ct.hide(),pt.hide(),e("#btnTogPanel").trigger("tap")},50)}else console.log("No Groups")},r.readAsText(t)},ft.error)},function(e){1==e.code?(1==w()?dt.groups():pt.hide(),b("Connection offline, Unable to download groups","long","bottom")):ft.error(e)})},ft.error)},ft.error)},data:function(){console.log("reading data file");var e=at.ID_Group+".json";window.requestFileSystem(r(),L,function(t){t.root.getDirectory("OSMobile/data",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.file(function(e){var t=new FileReader;t.onload=function(){if(b("Reading data from this device","short","top"),this.result.length>0){var e=JSON.parse(this.result);tt.lastUpdate=N(e.Date),z.length=0,V.length=0;for(var t=0;t<e.Maps.length;t++)z.push(e.Maps[t]);for(var t=0;t<e.Devices.length;t++)V.push(e.Devices[t]);d(),m(),Dt.empty(),bt.empty(),v(),setTimeout(function(){pt.hide()},250)}},t.readAsText(e)},ft.error)},function(e){1==e.code?1==w()?dt.maps():(pt.hide(),d(),m(),Dt.empty(),Dt.MoveForward(),b("Connection offline, Unable to download data","long","bottom")):ft.error(e)})},ft.error)},ft.error)},changes:function(e){var t="changes.json";try{window.requestFileSystem(r(),L,function(e){e.root.getDirectory("OSMobile",{create:!0},function(e){e.getFile(t,{create:!1},function(e){e.file(function(e){var t=new FileReader;t.onload=function(){if(this.result.length>0){var e=JSON.parse(this.result);alert(e.length),H=e}else alert("No Changes")},t.readAsText(e)},ft.error)},function(e){1==e.code?(pt.hide(),console.log("No chanegs file found")):ft.error(e)})},ft.error)},ft.error)}catch(e){alert(e.toString())}},maps:function(){var e=ot.Path.substr(ot.Path.lastIndexOf("/")+1),t="";window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile/maps",{create:!0},function(r){t=r.toURL(),r.getFile(e,{create:!1},function(e){var t=e.toURL();n(t)},function(r){1==r.code?1==w()?yt.map(e,t):(mt.forceMissingMap(),pt.hide(),b("Connection offline, Unable to download map","long","bottom")):ft.error(r)})},ft.error)},ft.error)},forceMissingMap:function(){n("missing.jpg"),pt.hide()},devImg:function(){var e=nt.Image.substr(nt.Image.lastIndexOf("/")+1),t="";window.requestFileSystem(r(),L,function(r){r.root.getDirectory("OSMobile/devimg",{create:!0},function(r){t=r.toURL(),r.getFile(e,{create:!1},function(e){var t=e.toURL();ut.loadImage(t)},function(r){1==r.code?1==w()?yt.devimg(e,t):(pt.hide(),alert("Unable to download device image. Please check your connection")):ft.error(r)})},ft.error)},ft.error)}},vt={settings:function(){var e="settings.json";window.requestFileSystem(r(),L,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},ft.error)},ft.error)},groups:function(){var e="groups.json";window.requestFileSystem(r(),L,function(t){t.root.getDirectory("OSMobile/data",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},ft.error)},ft.error)},data:function(){window.requestFileSystem(r(),L,function(e){e.root.getDirectory("OSMobile/data",{create:!0},function(e){var t=e.createReader();t.readEntries(function(e){for(var t=0;t<e.length;t++)e[t].remove()},null)},ft.error)},ft.error)},changes:function(){var e="changes.json";window.requestFileSystem(r(),L,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(e,{create:!1},function(e){e.remove(null,null)},null)},ft.error)},ft.error)}},ft={error:function(e){var t="";switch(e.code){case FileError.ENCODING_ERR:t="The url is malformed.";break;case FileError.INVALID_MODIFICATION_ERR:t="The modification requested is not allowed. For example, the app might be trying to move a directory into its own child or moving a file into its parent directory without changing its name";break;case FileError.INVALID_STATE_ERR:t="The operation cannot be performed on the current state of the interface object.";break;case FileError.NO_MODIFICATION_ALLOWED_ERR:t="The state of the underlying file system prevents any writing to a file or a directory.";break;case FileError.NOT_FOUND_ERR:t="A required file or directory could not be found.";break;case FileError.NOT_READABLE_ERR:t="The file or directory cannot be read, typically due to permission problems that occur after a reference to a file has been acquired.";break;case FileError.PATH_EXISTS_ERR:t="The file or directory with the same path already exists.";break;case FileError.QUOTA_EXCEEDED_ERR:t="Either there's not enough remaining storage space or the storage quota was reached or the user declined to give more space to the database.";break;case FileError.SECURITY_ERR:t="SECURITY_ERR ";break;case FileError.TYPE_MISMATCH_ERR:t="The app looked up an entry,but the entry found is of the wrong type.For example, the app is asking for a directory, when the entry is really a file.";break;default:t="Unknown Error "}alert(t+" "+e.code),console.log(t+" "+e.code)}},wt={MoveForward:function(t){if(0==e("#GroupsMasterGroup").children().length)console.log("Create Root"),wt.RootGroup();else{var r=!1,o=null;e.each(e("#GroupsMasterGroup>panel.group").children(),function(n,a){e(a).attr("child")==t&&(r=!0,o=e(a))}),0==r?(console.log("Create SubGroup"),wt.CreateSubGroup(t)):setTimeout(function(){e("#GroupsMasterGroup>panel.group").children("[open]").removeAttr("open").attr("left",""),o.removeAttr("right").attr("open",""),e("#GroupsMasterGroup").parent().next().removeAttr("novis"),pt.hide()},10)}},RootGroup:function(){e("#GroupsMasterGroup").empty();var t="";t+="<panel class='group'>";var r=W[0],o="hasKids";0==wt.CheckForChildren(r)&&(o+=" hide"),t+="<panel open class='child' root><scroll class='y'><row class='content'>",t+="<row class='item' groupid='"+r.ID_Group+"' fullpath='"+r.FullPath+"' groupPath='"+r.GroupPath+"'' ><span><name>"+r.ID_Group+" - "+r.Name+"</name></span><a class='button "+o+" ' href='#'></a><a class='button isselected' href='#'></a></row>",t+="</row></scroll></panel></panel>",e("#GroupsMasterGroup").append(t),e("#GroupsMasterGroup").parent().next().attr("novis",""),pt.hide()},CreateSubGroup:function(t){var r=e("#GroupsMasterGroup>panel.group"),o="";o+="<panel right class='child' child='"+t+"' ><scroll class='y'><row class='content'>";for(var n=new Array,a=W.slice(0),i=1;i<a.length;i++)a[i].FullPath==t+""+a[i].ID_Group+"."&&n.push(a[i]);for(var i=0;i<n.length;i++){var s="haskids";0==wt.CheckForChildren(n[i])&&(s+=" hide"),o+="<row class='item' groupid='"+n[i].ID_Group+"' fullpath='"+n[i].FullPath+"' groupPath='"+n[i].GroupPath+"'' ><span><name>"+n[i].ID_Group+" - "+n[i].Name+"</name></span><a class='button "+s+" ' href='#'></a><a class='button isselected' href='#'></a></row>"}o+="</row></scroll></panel>",e(r).append(o),setTimeout(function(){e(r).children("[open]").removeAttr("open").attr("left",""),e(r).children(":last-child").removeAttr("right").attr("open",""),e("#GroupsMasterGroup").parent().next().removeAttr("novis"),pt.hide()},10)},CheckForChildren:function(e){for(var t=0,r=W.slice(0),o=0;o<r.length;o++)r[o].GroupPath==e.GroupPath+"."+e.ID_Group&&t++;return t}},Dt={current:0,RootGroup:function(){e("#DevicesonMapGroup").empty();var t="";t+="<panel class='group'>",t+="<panel open class='child '><scroll class='y'><row class='content'>";for(var r=0;r<it[0].length;r++){var o=it[0][r].ID_Device,n=it[0][r].Description,a=it[0][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",t+="</panel>",t+='<actionbar><a href="#" class="button backward" id="btnBackwards_On"></a><indicator>0</indicator><a href="#" class="button forward" id="btnforwards_On"></a></actionbar>',e("#DevicesonMapGroup").empty().append(t),t.length=0,Dt.current=0,pt.hide()},NextGroup:function(){var t="";t+="<panel right class='child '><scroll class='y'><row class='content'>",console.log(Dt.current);for(var r=0;r<Dt[Dt.current].length;r++){var o=Dt[Dt.current][r].ID_Device,n=Dt[Dt.current][r].Description,a=Dt[Dt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#DevicesonMapGroup>panel.group").append(t),e("#DevicesonMapGroup>panel.group>panel.child").attr("left","").removeAttr("open").removeAttr("right"),e("#DevicesonMapGroup>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#DevicesonMapGroup>panel.group>panel.child:first-child").remove()},700),t.length=0,pt.hide()},PrevGroup:function(){var t="";t+="<panel left class='child '><scroll class='y'><row class='content'>",console.log(Dt.current);for(var r=0;r<Dt[Dt.current].length;r++){var o=Dt[Dt.current][r].ID_Device,n=Dt[Dt.current][r].Description,a=Dt[Dt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item mDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#DevicesonMapGroup>panel.group").append(t),e("#DevicesonMapGroup>panel.group>panel.child").attr("right","").removeAttr("open").removeAttr("left"),e("#DevicesonMapGroup>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#DevicesonMapGroup>panel.group>panel.child:first-child").remove()},700),t.length=0,pt.hide()},empty:function(){Dt.current=-1;var t="";t+="<row class='item none' id='none'><span><name>No Devices</name><serial>This map has no devices</serial></span></row>",console.log("Drawing"),e("#DevicesonMapGroup").empty().append(t),t.length=0,pt.hide()},MoveForward:function(){it.length>0?-1==Dt.current?(pt.hide(),pt.show(),Dt.RootGroup()):(Dt.current++,Dt.current<it.length?(pt.hide(),pt.show(),Dt.NextGroup(),e("a.button#btnforwards_On").prev("indicator").html(bt.current)):Dt.current--):Dt.empty()},MoveBackward:function(){Dt.curernt--,Dt.current<0?Dt.current=0:(pt.hide(),pt.show(),Dt.PrevGroup(),e("a.button#btnforwards_On").prev("indicator").html(bt.current))}},bt={current:0,RootGroup:function(){var t="";t+="<panel class='group'>",t+="<panel open class='child '><scroll class='y'><row class='content'>";for(var r=0;r<st[0].length;r++){var o=st[0][r].ID_Device,n=st[0][r].Description,a=st[0][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",t+="</panel>",t+='<actionbar><a href="#" class="button backward" id="btnBackwards_Off"></a><indicator>0</indicator><a href="#" class="button forward" id="btnforwards_Off"></a></actionbar>',e("#MissingDevicesGroups").empty().append(t),t.length=0,bt.current=0,pt.hide()},NextGroup:function(){var t="";t+="<panel right class='child '><scroll class='y'><row class='content'>",console.log(bt.current);for(var r=0;r<st[bt.current].length;r++){var o=st[bt.current][r].ID_Device,n=st[bt.current][r].Description,a=st[bt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"}t+="</row></scroll></panel>",e("#MissingDevicesGroups>panel.group").append(t),e("#MissingDevicesGroups>panel.group>panel.child").attr("left","").removeAttr("open").removeAttr("right"),e("#MissingDevicesGroups>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#MissingDevicesGroups>panel.group>panel.child:first-child").remove()},700),t.length=0,pt.hide()},PrevGroup:function(){var t="";t+="<panel left class='child '><scroll class='y'><row class='content'>",console.log(bt.current);for(var r=0;r<st[bt.current].length;r++){var o=st[bt.current][r].ID_Device,n=st[bt.current][r].Description,a=st[bt.current][r].SerialNumber;0==n.length&&(n="No Description"),0==a.length&&(a="No Serial Number"),t+="<row class='button item uDevice' id='"+o+"'><span><name>"+n+"</name><serial>"+a+"</serial></span></row>"
}t+="</row></scroll></panel>",e("#MissingDevicesGroups>panel.group").append(t),e("#MissingDevicesGroups>panel.group>panel.child").attr("right","").removeAttr("open").removeAttr("left"),e("#MissingDevicesGroups>panel.group>panel.child:last-child").attr("open","").removeAttr("left").removeAttr("right"),setTimeout(function(){e("#MissingDevicesGroups>panel.group>panel.child:first-child").remove()},700),t.length=0,pt.hide()},empty:function(){bt.current=-1;var t="";t+="<row class='item none' id='none'><span><name>No Devices</name><serial>This map has no devices</serial></span></row>",e("#MissingDevicesGroups").empty().append(t),t.length=0,pt.hide()},MoveForward:function(){st.length>0?-1==bt.current?(pt.hide(),pt.show(),bt.RootGroup()):(bt.current++,bt.current<st.length?(pt.hide(),pt.show(),bt.NextGroup(),e("a.button#btnforwards_Off").prev("indicator").html(bt.current)):bt.current--):bt.empty()},MoveBackward:function(){bt.current--,bt.current<0?bt.current=0:(pt.hide(),pt.show(),bt.PrevGroup(),e("a.button#btnforwards_Off").prev("indicator").html(bt.current))}},yt={map:function(e,t){var r=new FileTransfer,o=encodeURI(J+"/Maps/"+e),n=t+"/"+e;r.download(o,n,function(){mt.maps(),pt.hide()},function(e){switch(e.code){case FileTransferError.FILE_NOT_FOUND_ERR:b("Cannot find Map Image","long","bottom"),setTimeout(function(){mt.forceMissingMap()},1);break;case FileTransferError.INVALID_URL_ERR:alert("Server URL is incorrect.");break;case FileTransferError.CONNECTION_ERR:b("Cannot find connection path for Map Image","long","bottom"),setTimeout(function(){mt.forceMissingMap()},1);break;case FileTransferError.ABORT_ERR:msg+="Process was aborted.",pt.hide()}},!0,{headers:{Authorization:"Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="}})},devimg:function(e,t){var r=new FileTransfer,o=encodeURI(J+"/devimg/"+e),n=t+"/"+e;r.download(o,n,function(e){var t=e.toURL();ut.loadImage(t)},yt.error,!0,{headers:{Authorization:"Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="}})},error:function(e){var t="";switch(e.code){case FileTransferError.FILE_NOT_FOUND_ERR:t+="File cannot be found.";break;case FileTransferError.INVALID_URL_ERR:t+="Server URL is incorrect.";break;case FileTransferError.CONNECTION_ERR:t+="Cannot find connection path for Image download";break;case FileTransferError.ABORT_ERR:t+="Process was aborted."}alert(t),pt.hide()}},At={ready:function(){navigator.splashscreen.show(),R.online=!0,R.status="online",lt.hide(),A(),d(),m(),Dt.empty(),bt.empty(),v(),f(),R.type=1==C.Browser?"WiFi":navigator.connection.type,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),U&&(e("#inputUsername").val("craig"),e("#inputPassword").val("password")),mt.settings()},back:function(){e("#login").hasClass("visible")?navigator.app.exitApp():O("Do you want exit the app?",function(e){1==e&&navigator.app.exitApp()},"Exit App",["Exit","Cancel"])},pause:function(){navigator.splashscreen.hide()},resume:function(){navigator.splashscreen.hide()},online:function(){R.online=!0,R.status="online",R.type=navigator.connection.type,b("Device online","short","bottom"),e("#NetStatus").addClass("online").removeClass("offline"),1==tt.logged&&1==tt.changes&&O("Changes have been detected",function(t){1==t&&(mt.changes(),pt.show(),setTimeout(function(){dt.changes()},250)),2==t&&(H.length=0,vt.changes(),e("#btnDownload").trigger("tap"))},"Changes detected",["Upload","Ignore"])},offline:function(){R.online=!1,R.status="offline",R.type=navigator.connection.type,b("Device offline","short","bottom")}};document.addEventListener("deviceready",At.ready,!1),document.addEventListener("backbutton",At.back,!1),document.addEventListener("pause",At.pause,!1),document.addEventListener("resume",At.resume,!1),document.addEventListener("online",At.online,!1),document.addEventListener("offline",At.offline,!1);var Tt={preventMouse:!0,transformMinScale:1.1};e("#btnLogbook").hammer(Tt).on("tap",function(){lt.show(),e("#logbook").removeAttr("novis")}),e("#btnTogPanel").hammer(Tt).on("tap",function(t){t.preventDefault(),0==$&&($=!0,e("page#main").toggleClass("out").toggleClass("in"),e("map>viewport").attr("novis",""),l(),setTimeout(function(){e("map>viewport").removeAttr("novis"),s()},100),setTimeout(function(){$=!1},1e3))}),e("#btnLogin").hammer(Tt).on("tap",function(){if(""==e("#inputUsername").val()||""==e("#inputPassword").val())b("Username or password is blank","long","top");else if(pt.show(),1==w()){var r=e("#inputUsername").val(),o=e("#inputPassword").val();setTimeout(function(){t(r,o)},125)}else pt.hide(),b("Connection is offline","long","top")}),e("#btnDeviceComments").hammer(Tt).on("tap",function(){e("#DeviceComments").removeAttr("novis")}),e("#btnContinue").hammer(Tt).on("tap",function(){1==tt.logged?(b("Loading Groups","short","top"),pt.show(),1==w()?(ct.hide(),dt.groups()):(ct.hide(),mt.groups())):b("No previous user","short","center")}),e("#btnDownload").hammer(Tt).on("tap",function(){e("#MapTitle").empty().html("OneStop"),1==w()?(e("#MapsMasterPanel").removeAttr("left").removeAttr("right").attr("open",""),e("#DevicesOnMapPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("left",""),e("#MissingDevicesPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("right",""),e("#InformationPanel").removeAttr("open").removeAttr("left").removeAttr("right").attr("left",""),e("map>viewport>pog.selecteddevice").removeClass("selecteddevice"),e("#MapsMasterPanel").removeAttr("right").attr("open",""),c(),l(),pt.show(),ot=0,nt=0,z.length=0,V.length=0,H.length=0,Z.length=0,e("li.button.remove").removeClass("remove"),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),dt.maps()):(pt.hide(),b("Device offline. Unable to download data","long","center"))}),e("#btnBin").hammer(Tt).on("tap",function(){if(Z.length>0){b("Deleting devices - Remeber to save","short","top"),pt.show();for(var t=0;t<Z.length;t++){for(var r=0;r<V.length;r++)V[r].ID_Device==Z[t]&&(V[r].ID_Map=0,V[r].Image="devimg/default.png",V[r].Locked=!1,V[r].X=0,V[r].Y=0);F(Z[t])}ht.data(),it.length=0,st.length=0;for(var t=0;t<V.length;t++)V[t].ID_Map==ot.ID_Map&&it.push(V[t]),0==V[t].ID_Map&&st.push(V[t]);it=u(it),st=u(st),Dt.empty(),bt.empty(),g(),h(),setTimeout(function(){Dt.MoveForward()},100),i(),e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),e("#deleteoptions").html("0"),Z.length=0}else b("Nothing to delete","short","top")}),e("map>viewport>img").hammer(Tt).on("touch",function(){e("map>viewport>.selecteddevice").removeClass("selecteddevice")}),e("#btnSave").hammer(Tt).on("tap",function(){if(H.length>0)if(1==w())pt.show(),setTimeout(function(){dt.changes()},100);else{pt.show();for(var e=new Array,t=0;t<H.length;t++)e.push(H[t]);H.length=0;var o="changes.json";try{window.requestFileSystem(r(),L,function(t){t.root.getDirectory("OSMobile",{create:!0},function(t){t.getFile(o,{create:!1},function(t){t.file(function(t){var r=new FileReader;r.onload=function(){if(this.result.length>0){var t=JSON.parse(this.result);H=t,H.splice(H.length-1,1);for(var r=0;r<e.length;r++)H.push(e[r]);tt.changes=1,ht.settings(),ht.changes(),ht.data(),setTimeout(function(){pt.hide(),b("Changes saved local","short","top")},100)}else alert("No Changes")},r.readAsText(t)},ft.error)},function(t){if(1==t.code){for(var r=0;r<e.length;r++)H.push(e[r]);tt.changes=1,ht.settings(),ht.changes(),ht.data(),setTimeout(function(){pt.hide(),b("Changes saved local","short","top")},100)}else ft.error(t)})},ft.error)},ft.error)}catch(n){alert(n.toString())}}else b("0 changes have been made","short","top")});var It=!1;e(window).hammer(Tt).on("tap","a.button.back#btnBack",function(){if(0==It){if(It=!0,"MissingDevicesPanel"==e(this).parents("panel.child").attr("id")&&(e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").removeAttr("right").attr("open")),"InformationPanel"==e(this).parents("panel.child").attr("id")){if(e("#InformationPanel").removeAttr("open").attr("left",""),1==et){e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right",""),it.length=0;for(var t=0;t<V.length;t++)V[t].ID_Map==ot.ID_Map&&it.push(V[t]);it=u(it),Dt.empty(),g(),setTimeout(function(){Dt.MoveForward()},100),et=!0}else e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right","");if(1==DeviceAdd){e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").attr("open",""),it.length=0,st.length=0;for(var t=0;t<V.length;t++)V[t].ID_Map==ot.ID_Map&&it.push(V[t]),0==V[t].ID_Map&&st.push(V[t]);it=u(it),st=u(st),Dt.empty(),bt.empty(),g(),h(),setTimeout(function(){Dt.MoveForward(),bt.MoveForward()},100),DeviceAdd=!0}else e("#DevicesOnMapPanel").removeAttr("right").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("right").removeAttr("left").removeAttr("open").attr("right","")}if("DevicesOnMapPanel"==e(this).parents("panel.child").attr("id")&&(e("#DevicesOnMapPanel").removeAttr("open").attr("left",""),e("#MapsMasterPanel").removeAttr("right").removeAttr("left").attr("open","")),"GroupSelect"==e(this).parents("page.floating").attr("id")){console.log("OK");var r=e(this).parents("actionbar").prev().find("panel[open]");null!=r.prev().attr("root")&&e("#GroupsMasterGroup").parent().next().attr("novis",""),e.each(e("#GroupsMasterGroup>panel.group").find("row.item"),function(t,o){e(o).attr("fullpath")==r.attr("child")&&(r.removeAttr("open").attr("right",""),e(o).parents("panel.child").removeAttr("left").removeAttr("right").attr("open",""))})}e("map>viewport>pog.selecteddevice").removeClass("selecteddevice")}setTimeout(function(){It=!1},700)}),e("#btnExit").hammer(Tt).on("tap",function(){navigator.app.exitApp()});var Mt=!1;e(window).hammer(Tt).on("tap",".map",function(){if(0==Mt){Mt=!0;var t=e(this).attr("id");if(e("li.button.remove").removeClass("remove"),Z.length=0,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),ot.ID_Map==t)setTimeout(function(){e("#MapsMasterPanel").removeAttr("open").attr("right",""),e("#DevicesOnMapPanel").removeAttr("left").attr("open",""),pt.hide()},1);else{pt.show(),c();for(var r=0;r<z.length;r++)z[r].ID_Map==t&&(ot=z[r]);f(),setTimeout(function(){it.length=0,st.length=0;for(var e=0;e<V.length;e++)V[e].ID_Map==ot.ID_Map&&it.push(V[e]),0==V[e].ID_Map&&st.push(V[e]);it=u(it),st=u(st),Dt.empty(),bt.empty(),g(),h(),setTimeout(function(){Dt.MoveForward()},100)},100),mt.maps()}}setTimeout(function(){Mt=!1},200)});var Ft={preventDefault:!0,preventMouse:!0},St={event:null,target:null,dist:0,maxdist:0,scrolling:!1,scrolltimeout:!1,dragging:!1},kt=null;e("scroll.y").hammer(Tt).on("scroll",function(t){t.preventDefault(),0==St.dragging?(e(St.target).css("-webkit-transform",""),St.event=null,St.target=null,clearTimeout(kt),St.scrolltimeout=!0,kt=setTimeout(function(){console.log("Timeout Scrolling"),St.scrolltimeout=!1},500)):(t.preventDefault(),t.gesture.stopDetect())}),e(window).hammer(Ft).on("tap dragright dragup dragdown release",".mDevice",function(t){switch(t.type){case"tap":t.stopPropagation(),t.preventDefault();var r=e(this).attr("id");nt=S(r),e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==nt.ID_Device&&e(r).addClass("selecteddevice")}),setTimeout(function(){e("#DevicesOnMapPanel").removeAttr("open").attr("right",""),e("#MissingDevicesPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open","")},10),T();break;case"dragright":0==St.scrolltimeout&&0==St.scrolltimeout&&(St.dragging=!0,St.event="dragright",St.target=e(this),St.maxdist=parseFloat(e(St.target).width())/2/2,t.gesture.distance=Math.min(St.maxdist,t.gesture.distance),e(St.target).css("-webkit-transform","translate3d("+t.gesture.distance+"px,0px,0px)"),e(St.target).parents("scroll").attr("scroll",e(St.target).parents("scroll").scrollTop()),St.dist=t.gesture.distance);break;case"release":if(0==St.scrolltimeout&&0==St.scrolltimeout){if(St.dist==St.maxdist&&"dragright"==St.event){if(e(St.target).hasClass("remove")){for(var o=0;o<Z.length;o++)Z[o]==e(St.target).attr("id")&&(Z.splice(o,1),e("#deleteoptions").html(Z.length+" selected"));try{e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==e(St.target).attr("id")&&e(r).removeClass("togDelete")})}catch(t){alert(t.toString()+" adding errror")}e(St.target).removeClass("remove")}else{try{e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==e(St.target).attr("id")&&e(r).addClass("togDelete")})}catch(t){alert(t.toString()+" removal errror")}Z.push(e(St.target).attr("id")),e("#deleteoptions").html(Z.length+" selected"),e(St.target).addClass("remove")}Z.length>0?(e("#deleteoptions").removeAttr("novis"),e("#deleteoptions").prev().attr("novis","")):(e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis")),e(St.target).css("-webkit-transform",""),e(St.target).parents("scroll").scrollTop(e(St.target).parents("scroll").attr("scroll")),St.target=null,St.event=null,St.dist=0,St.maxdist=0}else e(St.target).css("-webkit-transform",""),St.target=null;St.dragging=!1}}}),e(window).hammer(Ft).on("tap drag dragright release",".uDevice",function(t){switch(t.type){case"drag":0==St.scrolltimeout&&(t.gesture.center.pageX>e(this).parents("panel.master").width()?(e("#ulFloat").removeAttr("novis"),e("#ulFloat").css({left:t.gesture.center.pageX,top:t.gesture.center.pageY})):(e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:0,top:0})));break;case"dragright":if(0==St.scrolltimeout&&0==St.scrolltimeout){null==St.target&&(St.target=e(this)),e(St.target).parents("scroll").attr("scroll",e(St.target).parents("scroll").scrollTop());var r=t.gesture.center.pageX-e(St.target).width()/2/2;e(St.target).css({"-webkit-transform":"translate3d("+r+"px,"+0+"px,0px)"}),e(St.target).parents("scroll").css("overflow-y","hidden"),e(St.target).parents("scroll").scrollTop(e(St.target).parents("scroll").attr("scroll"))}break;case"release":if(0==St.scrolltimeout&&0==St.scrolltimeout){e(St.target).css({"-webkit-transform":""}),e(St.target).parents("scroll").css("overflow-y","auto"),e(St.target).parents("scroll").scrollTop(e(St.target).parents("scroll").attr("scroll"));var r=t.gesture.center.pageX,o=t.gesture.center.pageY,n=document.elementFromPoint(r,o);"IMG"==n.nodeName||"POG"==n.nodeName?(e("#ulFloat").attr("value",e(St.target).attr("id")),Z.length=0,e("#deleteoptions").attr("novis",""),e("#deleteoptions").prev().removeAttr("novis"),e("#deleteoptions").html("0"),a(r,o),e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:"",top:""}),e("#ulFloat").attr("value",null)):(e("#ulFloat").attr("novis",""),e("#ulFloat").css({left:"",top:""}),e("#ulFloat").attr("value",null)),St.target=null}}}),e(window).hammer(Tt).on("tap","map>viewport>pog",function(){e("map>viewport>pog.selecteddevice").removeClass("selecteddevice");var t=S(e(this).attr("id"));nt=t,e(this).addClass("selecteddevice"),setTimeout(function(){e("#DevicesOnMapPanel").removeAttr("open").attr("right",""),e("#InformationPanel").removeAttr("left").attr("open",""),e("#MissingDevicesPanel").removeAttr("open").attr("right","")},10),T()});var Nt={startObj:null,delta:{x:0,y:0},dtObj:null,doubletap:!1};e(document.body).hammer().on("dragstart drag dragend","map>viewport>pog.unlocked",function(t){switch(e("map>viewport>pog.selecteddevice").removeClass("selecteddevice"),t.type){case"dragstart":var r=S(e(this).attr("id"));nt=r,T(),Nt.startObj=e(this);break;case"drag":var o=e("map").position(),n={w:e("map>viewport>img").width(),h:e("map>viewport>img").height()},a=e("map>viewport>img").attr("offset").split(" ")[0],i=e("map>viewport>img").attr("offset").split(" ")[1],s=10,l=parseFloat(n.w)-2*s,c=parseFloat(n.h)-s;Nt.delta.x=t.gesture.center.pageX-parseFloat(o.left)-parseFloat(a),Nt.delta.y=t.gesture.center.pageY-parseFloat(o.top)-parseFloat(i),Nt.delta.x=Math.max(s,Nt.delta.x),Nt.delta.y=Math.max(s,Nt.delta.y),Nt.delta.x=Math.min(l,Nt.delta.x),Nt.delta.y=Math.min(c,Nt.delta.y);var p="",u="1,0,0,-1",d="1,0, 0, 1",t="0,-1, 1, 0",g="0, 1, -1, 0";p=d,Nt.delta.x<70&&(p=g),Nt.delta.x>parseFloat(n.w)-70&&(p=t),Nt.delta.y<70&&(p=u),e(Nt.startObj).css({"-webkit-transform":"matrix("+p+","+Nt.delta.x+","+Nt.delta.y+")"});for(var h=0;h<V.length;h++)V[h].ID_Device==e(Nt.startObj).attr("id")&&(V[h].X=Nt.delta.x/parseFloat(e("map>viewport>img").width())*j,V[h].Y=Nt.delta.y/parseFloat(e("map>viewport>img").height())*B,nt.ID_Device==V[h].ID_Device&&e("#infoDevicePosition").val(V[h].X.toFixed(0)+" : "+V[h].Y.toFixed(0)));break;case"dragend":console.log("Drag end");var m=e(Nt.startObj).css("-webkit-transform");m=m.substr(m.lastIndexOf("(")).replace(/\(|\)/g,"").split(", ");var v=parseFloat(m[4]),f=parseFloat(m[5]);v=v/parseFloat(e("map>viewport>img").width())*j,f=f/parseFloat(e("map>viewport>img").height())*B;for(var h=0;h<V.length;h++)V[h].ID_Device==e(Nt.startObj).attr("id")&&(V[h].X=v,V[h].Y=f,I(V[h].ID_Device,"position",V[h].X.toFixed(0)+" "+V[h].Y.toFixed(0)),nt.ID_Device==V[h].ID_Device&&e("#infoDevicePosition").val(V[h].X.toFixed(0)+" : "+V[h].Y.toFixed(0)));Nt.startObj=null}}),e("map>viewport").hammer(Tt).on("transformstart transform transformend",function(t){switch(t.preventDefault(),t.type){case"transformstart":E.start=t.gesture.center;break;case"transform":E.scale=Math.max(1,t.gesture.scale*E.oldScale),E.scale=Math.min(5,E.scale),E.matrix=e(this).css("-webkit-transform").replace(/(matrix)|([\()])/g," ").split(","),e(this).css("-webkit-transform","matrix("+E.scale+",0,0,"+E.scale+",0,0)");break;case"transformend":E.oldScale=E.scale,E.end=t.gesture.center}}),e("#inputselectGroup").parent().hammer(Tt).on("tap",function(){e("#MapTitle").empty().html("OneStop"),null!=e("page#GroupSelect").attr("novis")&&(lt.show(),setTimeout(function(){c(),l(),rt=!1,ot=new Object,nt=new Object,st.length=0,it.length=0,e("page#GroupSelect").removeAttr("novis")},10))}),e(window).hammer(Tt).on("tap","a.button.close",function(){lt.hide(),e(this).parent().parent().attr("novis",""),"logbook"==e(this).parents("page.floating").attr("id")&&e("#logbookLog").children(".master").removeClass("expand").removeClass("collapse").addClass("expand"),setTimeout(function(){},10)});var Ot=!1;e(window).hammer(Tt).on("tap","a.button.hasKids",function(){if(pt.show(),0==Ot){var t=e(this).parent().attr("fullPath");wt.MoveForward(t),Ot=!0}setTimeout(function(){Ot=!1},700)}),e(window).hammer(Tt).on("tap",".isselected",function(){var t=e(this).parent().attr("groupid");if(0==Ot){for(var r=0;r<W.length;r++)W[r].ID_Group==t&&y(r);Ot=!0,setTimeout(function(){e("#GroupSelect").attr("novis",""),lt.hide()},100)}setTimeout(function(){Ot=!1},700)}),e("#btnExtSelectCancel").hammer(Tt).on("tap",function(){try{ExtSelect.hide()}catch(e){console.log(e)}}),e("panel[right]>swipe").hammer(Tt).on("tap dragright swiperight dragleft swipeleft",function(t){e("#btnTogPanel").trigger("tap"),t.stopPropagation(),t.preventDefault(),t.gesture.stopDetect()}),e("#btnDeviceImageClose").hammer(Tt).on("tap",function(){e(this).parents("display.master").attr("novis","")}),e("#btnDeviceImage").hammer(Tt).on("tap",function(){lt.show(),ut.show(),mt.devImg()}),e("#btnUsePhoto").hammer(Tt).on("tap",function(){ut.hide(),ut.ClearImage(),setTimeout(function(){gt.getCameraroll()},10)}),e("#btnNewPhoto").hammer(Tt).on("tap",function(){ut.hide(),ut.ClearImage(),setTimeout(function(){gt.getPicture()},10)}),e("row.item>label.text").hammer(Tt).on("tap",function(){console.log(" working ");var t=e(this).children("input").attr("id"),r=["Ok","Cancel"];switch(console.log(t),t){case"infoDeviceDescription":_("Give the device a new description",function(e){1==e.buttonIndex&&D(e.input1,"description")},"Device Description",r,nt.Description);break;case"infoDeviceLocation":_("Change location",function(e){1==e.buttonIndex&&D(e.input1,"location")},"Device Location",r,nt.Location);break;case"infoDeviceSerialNumber":_("Change the serial number",function(e){1==e.buttonIndex&&D(e.input1,"serialnumber")},"Serial Number",r,nt.SerialNumber);break;case"infoDeviceAssetNumber":_("Give the device a new Asset number",function(e){1==e.buttonIndex&&D(e.input1,"assetnumber")},"Asset Number",r,nt.AssetNumber);break;case"infoDevicePosition":return 0}}),e("a.button.locate").hammer(Tt).on("tap",function(){e.each(e("map>viewport>pog"),function(t,r){e(r).attr("id")==nt.ID_Device&&e(r).addClass("selecteddevice")})}),e("#infoDeviceLock").hammer(Tt).on("change",function(){D(e("#infoDeviceLock").prop("checked"),"locked")}),e(window).hammer(Tt).on("tap","dropdown.master>actionbar",function(){e(this).parent().toggleClass("expand").toggleClass("collapse"),e(this).next().children().removeClass("collapse").addClass("expand")}),e("#btnClearLog").hammer(Tt).on("tap",function(){e("#logbookLog").empty()}),e("#inputUsername, #inputPassword").on("focus blur",function(t){"focus"==t.type&&e(this).focus(),e(this).parents("div").css({"margin-bottom":"50%"}),"blur"==t.type&&e(this).parents("div").css({"margin-bottom":"0%"})}),e("#btnAddDevices").hammer(Tt).on("tap",function(){K||(K=!0,e(this).parents("panel.child").removeAttr("left").attr("left",""),e("#MissingDevicesPanel").removeAttr("right").attr("open",""),bt.empty(),pt.show(),h(),setTimeout(function(){bt.MoveForward()},500),setTimeout(function(){K=!1},700))}),e("shadow").hammer(Tt).on("touch release",function(){e("#GroupSelect").attr("novis")||e("#GroupSelect").attr("novis",""),e("#logbook").attr("novis")||(e("#logbook").attr("novis",""),e("#logbookLog").children(".master").removeClass("expand").removeClass("collapse").addClass("expand")),e("#DeviceImageDisplay").attr("novis")||ut.hide(),lt.hide()}),e(window).hammer(Tt).on("tap","a.button#btnforwards_Off",function(){bt.MoveForward()}),e(window).hammer(Tt).on("tap","a.button#btnbackwards_Off",function(){bt.MoveBackward()}),e(window).hammer(Tt).on("tap","a.button#btnforwards_On",function(){Dt.MoveForward()}),e(window).hammer(Tt).on("tap","a.button#btnbackwards_On",function(){Dt.MoveBackward()}),e(window).hammer(Tt).on("tap","a.button#btnforwards",function(){var t=e(this).prev("indicator"),r=parseInt(t.html()),o=e(this).parent().prev();if(console.log(o),0!=o.children("panel[open]").next().length&&!Q){var n=o.children("panel[open]"),a=n.next();a.show(),Q=!0,t.html(r+=1),setTimeout(function(){n.removeAttr("open").attr("left",""),a.show().removeAttr("right").attr("open","")},0),setTimeout(function(){Q=!1,n.hide()},700)}}),e(window).hammer(Tt).on("tap","a.button#btnbackwards",function(){var t=e(this).next("indicator"),r=parseInt(t.html()),o=e(this).parent().prev();if(0!=o.children("panel[open]").prev().length&&!Q){var n=o.children("panel[open]"),a=n.prev();a.show(),Q=!0,t.html(r-=1),setTimeout(function(){n.removeAttr("open").attr("right",""),a.removeAttr("left").attr("open","")},0),setTimeout(function(){Q=!1,n.hide()},700)}}),e(window,document).on("submit",function(e){return e.preventDefault(),!1}),e(window).hammer(Tt).on("touch","input",function(e){e.preventDefault()})}catch(_t){alert(_t.toString()),console.log(_t.toString())}});